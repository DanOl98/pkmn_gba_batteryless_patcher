namespace BatterylessPatcher
{
    public class PatcherFRLGITA
    {
        public static readonly byte[] BLOB = Hex("00 00 A0 E1 E0 00 9F E5 E0 10 9F E5 E0 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A BC 00 9F E5 10 FF 2F E1 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 78 00 A0 E3 00 08 A0 E1 02 13 A0 E3 01 00 80 E1 0E 14 A0 E3 10 20 A0 E3 02 26 A0 E1 00 30 D0 E5 00 00 A0 E1 00 40 D0 E5 04 00 53 E1 FA FF FF 1A 00 30 C1 E5 01 10 81 E2 01 00 80 E2 01 20 52 E2 F5 FF FF 1A 09 04 A0 E3 01 10 A0 E3 00 10 C0 E5 78 00 A0 E3 01 00 80 E2 00 08 A0 E1 02 13 A0 E3 01 00 80 E1 E1 16 A0 E3 10 20 A0 E3 02 26 A0 E1 00 30 D0 E5 00 00 A0 E1 00 40 D0 E5 04 00 53 E1 FA FF FF 1A 00 30 C1 E5 01 10 81 E2 01 00 80 E2 01 20 52 E2 F5 FF FF 1A 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 00 00 A0 E1 0C 00 9F E5 10 FF 2F E1 10 FC 03 02 30 00 76 08 FC 00 76 08 04 02 00 08 00 00 A0 E1 01 25 05 4C 20 47 30 BC 01 BC 00 47 02 25 02 4C 20 47 F0 BC 02 BC 08 47 60 01 76 08 00 00 00 00 1F B4 0A 49 0A 4A 0B 4B 0C 68 1C 60 09 1D 1B 1D 91 42 F9 D1 08 49 08 47 08 4B 00 28 02 D0 01 21 19 70 01 E0 00 21 19 70 1F BC 70 47 38 01 76 08 60 01 76 08 00 FC 03 02 01 FC 03 02 00 00 00 09 FF 00 2D E9 FC 00 9F E5 1C 10 1F E5 B0 20 D0 E1 B0 20 C1 E1 F0 00 9F E5 F0 10 9F E5 B0 20 D0 E1 B2 20 C1 E0 01 03 A0 E3 B2 28 D0 E1 B2 20 C1 E0 B0 28 D0 E1 B2 20 C1 E0 BA 2B D0 E1 B2 20 C1 E0 B6 2C D0 E1 B2 20 C1 E0 B2 2D D0 E1 B2 20 C1 E0 BE 2D D0 E1 B2 20 C1 E0 00 00 A0 E3 A4 10 9F E5 B0 00 C1 E1 A0 10 9F E5 B0 00 C1 E1 01 13 A0 E3 B0 08 C1 E1 BA 0B C1 E1 B6 0C C1 E1 B2 0D C1 E1 BE 0D C1 E1 03 00 A0 E3 B2 08 C1 E1 80 00 9F E5 B0 10 D0 E1 21 00 00 EA 68 00 9F E5 B0 10 1F E5 B0 20 D1 E1 B0 20 C0 E1 5C 00 9F E5 5C 10 9F E5 B2 20 D1 E0 B0 20 C0 E1 01 03 A0 E3 B2 20 D1 E0 B2 28 C0 E1 B2 20 D1 E0 B0 28 C0 E1 B2 20 D1 E0 BA 2B C0 E1 B2 20 D1 E0 B6 2C C0 E1 B2 20 D1 E0 B2 2D C0 E1 B2 20 D1 E0 BE 2D C0 E1 FF 00 BD E8 01 00 55 E3 01 00 00 0A 18 10 9F E5 11 FF 2F E1 14 00 9F E5 10 FF 2F E1 08 02 00 04 00 02 00 04 02 FC 03 02 84 00 00 04 13 01 76 08 07 01 76 08 9C 01 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A C0 01 1F E5 10 FF 2F E1 B4 02 76 08 F8 03 76 08 02 33 A0 E3 FF 10 A0 E3 B0 10 C3 E1 50 10 A0 E3 B0 10 C3 E1 90 10 A0 E3 B0 10 C3 E1 02 30 83 E2 B0 10 D3 E1 02 30 53 E2 89 2C A0 E3 02 00 82 E3 00 00 51 E1 3B 00 00 0A 04 00 82 E3 00 00 51 E1 38 00 00 0A 22 2B A0 E3 15 00 82 E3 00 00 51 E1 30 00 00 0A 10 00 82 E3 00 00 51 E1 2D 00 00 0A 0E 00 82 E3 00 00 51 E1 2A 00 00 0A 7D 00 82 E3 00 00 51 E1 2B 00 00 0A B0 00 82 E3 00 00 51 E1 28 00 00 0A 13 00 82 E3 00 00 51 E1 21 00 00 0A 0C 00 82 E3 00 00 51 E1 1E 00 00 0A 0F 00 82 E3 00 00 51 E1 1B 00 00 0A 12 00 82 E3 00 00 51 E1 18 00 00 0A 16 00 82 E3 00 00 51 E1 15 00 00 0A 55 00 82 E3 00 00 51 E1 12 00 00 0A 57 00 82 E3 00 00 51 E1 0F 00 00 0A C6 00 82 E3 00 00 51 E1 0C 00 00 0A C4 00 82 E3 00 00 51 E1 09 00 00 0A 0D 00 82 E3 00 00 51 E1 06 00 00 0A 0E 00 82 E3 00 00 51 E1 03 00 00 0A F0 10 A0 E3 B0 10 C3 E1 20 10 9F E5 11 FF 2F E1 FF 10 A0 E3 B0 10 C3 E1 14 10 9F E5 11 FF 2F E1 FF 10 A0 E3 B0 10 C3 E1 08 10 9F E5 11 FF 2F E1 FC 03 76 08 D0 0C 76 08 DC 0A 76 08 00 00 A0 E1 18 03 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 3C 03 1F E5 10 FF 2F E1 30 04 76 08 AC 04 76 08 02 33 A0 E3 F0 10 A0 E3 B0 10 C0 E1 AA 2E 83 E2 0A 20 82 E2 A9 10 A0 E3 B0 10 C2 E1 55 2E 83 E2 05 20 82 E2 56 10 A0 E3 B0 10 C2 E1 AA 2E 83 E2 0A 20 82 E2 90 10 A0 E3 B0 10 C2 E1 02 20 83 E2 B0 10 D2 E1 22 2C A0 E3 7D 20 82 E2 02 00 51 E1 03 00 00 0A F0 10 A0 E3 B0 10 C3 E1 10 10 9F E5 11 FF 2F E1 F0 10 A0 E3 B0 10 C3 E1 04 10 9F E5 11 FF 2F E1 B0 04 76 08 30 09 76 08 00 00 A0 E1 CC 03 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A F0 03 1F E5 10 FF 2F E1 E4 04 76 08 78 05 76 08 02 33 A0 E3 70 40 9F E5 70 50 9F E5 70 60 9F E5 B0 40 C3 E1 55 2F 83 E2 B0 50 C2 E1 40 20 83 E2 B0 00 D2 E1 06 00 50 E1 0B 00 00 0A B0 40 C3 E1 AA 20 83 E2 B0 50 C2 E1 20 20 83 E2 B0 00 D2 E1 06 00 50 E1 08 00 00 0A F0 10 A0 E3 B0 10 C3 E1 30 10 9F E5 1A 10 51 E2 11 FF 2F E1 B0 40 C3 E1 00 00 A0 E3 20 10 9F E5 11 FF 2F E1 B0 40 C3 E1 04 00 A0 E3 14 10 9F E5 11 FF 2F E1 F0 F0 00 00 98 98 00 00 52 51 00 00 4A 09 76 08 28 07 76 08 7C 05 76 08 00 00 A0 E1 98 04 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A BC 04 1F E5 10 FF 2F E1 B0 05 76 08 24 07 76 08 78 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 2C 01 9F E5 2C 11 9F E5 2C 41 9F E5 2C 51 9F E5 2C 31 9F E5 06 30 53 E2 B0 30 C2 E1 B0 40 C0 E1 B0 50 C1 E1 1C 31 9F E5 B0 30 C0 E1 B0 40 C0 E1 B0 50 C1 E1 10 31 9F E5 B0 30 C2 E1 0D 00 00 EB 08 31 9F E5 04 30 53 E2 B0 30 C2 E1 B0 40 C0 E1 B0 50 C1 E1 F8 30 9F E5 B0 30 C0 E1 1E 00 00 EB F0 30 9F E5 05 30 53 E2 B0 30 C2 E1 E8 00 9F E5 0E 00 50 E2 10 FF 2F E1 00 40 2D E9 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 02 09 16 E3 04 00 00 1A 02 0A 16 E3 F8 FF FF 0A B0 60 D2 E1 02 09 16 E3 F5 FF FF 0A 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 80 00 16 E3 04 00 00 1A 20 00 16 E3 F8 FF FF 0A B0 60 D2 E1 80 00 16 E3 F5 FF FF 0A 00 40 BD E8 0E F0 A0 E1 04 40 2D E9 0E 14 A0 E3 10 30 A0 E3 03 36 A0 E1 01 60 D1 E4 01 70 D1 E4 07 64 86 E1 60 50 9F E5 B0 50 C2 E1 00 00 A0 E1 B0 60 C2 E1 01 0C A0 E3 B0 70 D2 E1 07 00 56 E1 01 00 00 0A 01 00 50 E2 FA FF FF 1A 02 20 82 E2 02 30 53 E2 EF FF FF 1A 04 40 BD E8 0E F0 A0 E1 AA 0A 00 08 54 05 00 08 A9 AA 00 00 56 55 00 00 F6 F0 00 00 80 80 00 00 30 30 00 00 F4 F0 00 00 20 20 00 00 F5 F0 00 00 06 02 76 08 A0 A0 00 00 00 00 A0 E1 44 06 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 68 06 1F E5 10 FF 2F E1 5C 07 76 08 2C 09 76 08 78 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 AC 01 9F E5 AC 11 9F E5 0F 10 51 E2 AA 4C A0 E3 A9 40 84 E3 55 5C A0 E3 56 50 85 E3 0F 3A A0 E3 F0 30 83 E3 B0 30 C2 E1 B0 40 C0 E1 B0 50 C1 E1 02 39 A0 E3 80 30 83 E3 B0 30 C0 E1 B0 40 C0 E1 B0 50 C1 E1 03 3A A0 E3 30 30 83 E3 B0 30 C2 E1 0D 00 00 EB 0F 3A A0 E3 F0 30 83 E3 B0 30 C2 E1 B0 40 C0 E1 B0 50 C1 E1 02 3A A0 E3 20 30 83 E3 B0 30 C0 E1 1D 00 00 EB 0F 3A A0 E3 F0 30 83 E3 B0 30 C2 E1 30 01 9F E5 10 FF 2F E1 00 40 2D E9 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 02 09 16 E3 04 00 00 1A 02 0A 16 E3 F8 FF FF 0A B0 60 D2 E1 02 09 16 E3 F5 FF FF 0A 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 80 00 16 E3 04 00 00 1A 20 00 16 E3 F8 FF FF 0A B0 60 D2 E1 80 00 16 E3 F5 FF FF 0A 00 40 BD E8 0E F0 A0 E1 04 40 2D E9 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 78 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 0E 14 A0 E3 10 30 A0 E3 03 36 A0 E1 10 00 00 EB 09 04 A0 E3 01 10 A0 E3 00 10 C0 E5 78 20 A0 E3 01 20 82 E2 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 E1 16 A0 E3 10 30 A0 E3 03 36 A0 E1 04 00 00 EB 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 04 40 BD E8 0E F0 A0 E1 00 40 2D E9 01 60 D1 E4 01 70 D1 E4 07 64 86 E1 0A 5A A0 E3 A0 50 85 E3 B0 50 C2 E1 00 00 A0 E1 B0 60 C2 E1 01 0C A0 E3 B0 70 D2 E1 07 00 56 E1 01 00 00 0A 01 00 50 E2 FA FF FF 1A 02 20 82 E2 02 30 53 E2 EE FF FF 1A 00 40 BD E8 0E F0 A0 E1 54 15 00 08 B9 0A 00 08 F8 01 76 08 00 00 A0 E1 4C 08 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 70 08 1F E5 10 FF 2F E1 64 09 76 08 D8 0A 76 08 00 01 2D E9 78 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 48 01 9F E5 AA 00 50 E2 44 11 9F E5 AA 10 51 E2 A9 40 A0 E3 56 50 A0 E3 1D 00 00 EB 35 00 00 EB 1B 00 00 EB 01 28 82 E2 32 00 00 EB 01 28 52 E2 09 64 A0 E3 EE 70 A0 E3 00 70 C6 E5 14 00 00 EB 10 30 A0 E3 03 36 A0 E1 0E 84 A0 E3 17 00 00 EB 09 64 A0 E3 EF 70 A0 E3 00 70 C6 E5 0C 00 00 EB 10 30 A0 E3 03 36 A0 E1 0E 84 A0 E3 01 88 88 E2 0E 00 00 EB 09 64 A0 E3 EE 70 A0 E3 00 70 C6 E5 03 00 00 EB 00 01 BD E8 C8 00 9F E5 AA 00 50 E2 10 FF 2F E1 00 40 2D E9 B0 40 C0 E1 B0 50 C1 E1 F0 30 A0 E3 B0 30 C2 E1 00 40 BD E8 0E F0 A0 E1 00 40 2D E9 01 60 D8 E4 01 70 D8 E4 07 64 86 E1 B0 40 C0 E1 B0 50 C1 E1 A0 70 A0 E3 B0 70 C0 E1 00 00 A0 E1 B0 60 C2 E1 B0 70 D2 E1 07 00 56 E1 FC FF FF 1A 02 20 82 E2 02 30 53 E2 F0 FF FF 1A 00 40 BD E8 0E F0 A0 E1 00 40 2D E9 B0 40 C0 E1 B0 50 C1 E1 80 30 A0 E3 B0 30 C0 E1 B0 40 C0 E1 B0 50 C1 E1 30 30 A0 E3 B0 30 C2 E1 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 80 00 16 E3 04 00 00 1A 20 00 16 E3 F8 FF FF 0A B0 60 D2 E1 80 00 16 E3 F5 FF FF 0A 00 40 BD E8 0E F0 A0 E1 54 0B 00 08 FE 05 00 08 A2 02 76 08 00 00 A0 E1 00 00 A0 E1 F8 09 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 1C 0A 1F E5 10 FF 2F E1 10 0B 76 08 CC 0C 76 08 78 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 42 00 00 EB 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 0E 54 A0 E3 10 30 A0 E3 03 36 A0 E1 0D 00 00 EB 09 04 A0 E3 01 10 A0 E3 00 10 C0 E5 01 58 85 E2 01 28 82 E2 07 00 00 EB 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 FF 00 A0 E3 B0 00 C2 E1 50 01 9F E5 04 00 50 E2 10 FF 2F E1 2C 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 70 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 EA 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 04 01 9F E5 B0 00 C2 E1 00 00 A0 E1 02 1C A0 E3 00 60 D5 E5 01 50 85 E2 00 70 D5 E5 01 50 85 E2 07 64 86 E1 B0 60 C2 E1 01 10 51 E2 01 00 00 0A 02 20 82 E2 F5 FF FF EA D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 02 20 82 E2 01 4B A0 E3 04 30 53 E0 D6 FF FF 1A FF 00 A0 E3 B0 00 C2 E1 2C 40 BD E8 0E F0 A0 E1 04 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 60 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 90 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 02 20 82 E2 00 00 D2 E5 03 00 00 E2 FC FF FF 1A 02 20 52 E2 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 20 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 04 40 BD E8 0E F0 A0 E1 FC 01 76 08 FF 01 00 00 00 00 A0 E1 EC 0B 1F E5 20 10 9F E5 20 20 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 10 0C 1F E5 10 FF 2F E1 04 0D 76 08 A0 0E 76 08 78 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 3B 00 00 EB 01 28 82 E2 39 00 00 EB 01 28 52 E2 0E 54 A0 E3 10 30 A0 E3 03 36 A0 E1 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 0D 00 00 EB 09 04 A0 E3 01 10 A0 E3 00 10 C0 E5 01 58 85 E2 01 28 82 E2 07 00 00 EB 09 04 A0 E3 00 10 A0 E3 00 10 C0 E5 FF 00 A0 E3 B0 00 C2 E1 28 01 9F E5 05 00 50 E2 10 FF 2F E1 2C 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 70 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 40 00 A0 E3 B0 00 C2 E1 00 60 D5 E5 01 50 85 E2 00 70 D5 E5 01 50 85 E2 07 64 86 E1 B0 60 C2 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 02 20 82 E2 02 30 53 E2 E0 FF FF 1A FF 00 A0 E3 B0 00 C2 E1 2C 40 BD E8 0E F0 A0 E1 04 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 60 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 90 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 02 20 82 E2 00 00 D2 E5 03 00 00 E2 FC FF FF 1A 02 20 52 E2 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 20 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 04 40 BD E8 0E F0 A0 E1 FD 01 76 08 00 00 A0 E1 00 00 A0 E1");
        public static int originalBlobPosition = 0x00760000;
        public static int originalSavePosition = 0x00780000;
        //idk precisely how many slots etc. in doubt, considering 20 8192 bytes slots
        public static int saveAreaSize = 0x2000*20;
        private const int ENTRY1_OFF = 0x101; 
        private const int ENTRY2_OFF = 0x10D; 
        private const int ENTRY3_OFF = 0x121; 


        private static readonly byte[] CHECK_PRE_CTX = Hex("FF 21 09 01 01 40 00 29");
        private static readonly byte[] CHECK_ORIG    = Hex("17 D1");
        private static readonly byte[] CHECK_PATCH   = Hex("C0 46");
        private static readonly byte[] EP1_ORIG_TAIL = Hex("1F 2C F6 D9 30 BC 01 BC 00 47 00 00");
        private static readonly byte[] EP2_ORIG_TAIL = Hex("08 60 28 1C F0 BC 02 BC 08 47 00 00");
        private static readonly byte[] EP3_ORIG_TAIL = Hex("03 00 06 00 0E 05 4B");

        private static Dictionary<uint, byte[]> toReplaceCalls = new Dictionary<uint, byte[]> {
        };
        private static Dictionary<uint, byte[]> toReplaceCallsFirst = new Dictionary<uint, byte[]> {
            { 0x08000204, Hex("12 00 A0 E3") },//RESET 
        };
        private static byte[] Hex(string s) =>
            Convert.FromHexString(new string(s.Where(c => !char.IsWhiteSpace(c)).ToArray()));
        private static int freeSpaceWanted =  (Utils.AlignUp(BLOB.Length, 0x10000) + 0x10000 + saveAreaSize);
        public static byte[] ApplyBatterylessPatch(
            byte[] rom, bool forceRepack)
        {
            if (rom is null || rom.Length < 0x200)
                throw new ArgumentException("ROM non valida o troppo corta.");

            byte[] outRom = rom;

            bool repack = forceRepack;
            bool hardRepack = forceRepack;
            if (!forceRepack)
            {
                int blobCheck = Utils.FindFirstFreeForBlob(outRom, freeSpaceWanted, 0, 0, "blob", 0x1000, new() { }, false);
                if (blobCheck == -1)
                {
                    Console.WriteLine("[WARN] No enough free space, will try to repack");
                    repack = true;
                    if (outRom.Length > 0x01000000)
                    {
                        Console.WriteLine("[WARN] ROM is also over 16M, will try to hard repack");
                        hardRepack = true;
                    }
                }
                else
                {
                    if (outRom.Length > 0x01000000)
                    {
                        Console.WriteLine("[WARN] ROM over 16M, will try to soft repack");
                        repack = true;
                    }
                }
            }
            if (repack)
            {
                bool retry = false;
                outRom = Repack.repack(rom, new() { }, !hardRepack, "16m");
                if (!hardRepack)
                {
                    if (outRom.Length > 0x01000000)
                    {
                        Console.WriteLine("[WARN] ROM still over 16M, will try hard repack");
                        retry = true;
                        hardRepack = true;
                    }
                    int blobCheck = Utils.FindFirstFreeForBlob(outRom, freeSpaceWanted, 0, 0, "blob", 0x1000, new() { }, false);
                    if (blobCheck == -1)
                    {
                        Console.WriteLine("[WARN] No enough free space after repack, will try hard repack");
                        retry = true;
                        hardRepack = true;
                    }
                }
                if (retry)
                {
                    outRom = Repack.repack(rom, new() { }, !hardRepack, "16m");
                }
            }
            if (outRom.Length > 0x01000000)
            {
                String err = "[ERR] ROM still over 16M, cannot patch";
                Console.WriteLine(err);
                throw new InvalidOperationException(err);
            }
            Console.WriteLine("[INFO] Applying patches");
            //SRAM PATCHES
            SRAMPatcher.ApplySRAMPatch(outRom);
            //BLOB & SAVE ZONE
            int blobOff = Utils.FindFirstFreeForBlob(outRom, freeSpaceWanted, 0, 0, "blob", 0x1000, new() { });
            uint blobBase = Utils.ROM_BASE + (uint)blobOff;
            Console.WriteLine($"[INFO] blob relocated at {blobOff:X}");
            Utils.CopyBlobAndFixInternals(outRom, BLOB, originalBlobPosition, blobOff, toReplaceCalls, toReplaceCallsFirst);
            Utils.PatchROMStartOffsetToBlob(outRom, blobBase);
            int saveOff = Utils.AlignUp(blobOff, 0x10000) + 0x20000;
            Console.WriteLine($"[INFO] Save base relocated at {saveOff:X}");
            Utils.PatchSaveBase(outRom, blobOff, BLOB.Length, (byte)((originalSavePosition >> 16) & 0xFF), (byte)((saveOff >> 16) & 0xFF));
            //CODE PATCHES
            int ep1 = Utils.FindPatternForPatch(outRom, EP1_ORIG_TAIL, true);
            if (ep1 >= 0)
            {
                Utils.ApplyPatch2(outRom, ep1 + 4, target: blobBase + ENTRY1_OFF);
                Console.WriteLine($"[PATCH] Patch 1 applied (address 0x{(ep1+4):x})");
            }
            else
            {
                Console.WriteLine("[PATCH] Patch 1 pattern not found");
            }
            int ep2 = Utils.FindPatternForPatch(outRom, EP2_ORIG_TAIL, true);
            if (ep2 >= 0)
            {
                Utils.ApplyPatch2(outRom, ep2 + 4, target: blobBase + ENTRY2_OFF);
                Console.WriteLine($"[PATCH] Patch 2 applied (address 0x{(ep2 + 4):x})");
            }
            else
            {
                Console.WriteLine("[PATCH] Patch 2 pattern not found");
            }        
            int chk = Utils.FindCheckAndPatch(outRom, CHECK_PRE_CTX, CHECK_ORIG, CHECK_PATCH);
            int ep3 = Utils.FindPatternForPatch(outRom, EP3_ORIG_TAIL, true);
            if (ep3 >= 0)
            {
                Utils.ApplyPrePatch3(outRom, ep3 + 1, 16);
                Utils.ApplyPatch3(outRom, ep3 + 17, target: blobBase + ENTRY3_OFF);
                Console.WriteLine($"[PATCH] Patch 3 applied (address 0x{(ep3 + 4):x})");
            }
            else
            {
                Console.WriteLine("[PATCH] Patch 3 pattern not found");
            }

            Console.WriteLine("[INFO] ROM Patched");
            return outRom;
        }

   
    }
}
