namespace BatterylessPatcher
{
    //DISABLED, BAD PATCH, THE OTHER ONE IS BETTER, NEVER IMPLEMENTED POINTERS
    public class PatcherRSUSA
    {

        private static readonly byte[] BLOB = Hex("44 D0 9F E5 F8 00 A0 E3 00 08 A0 E1 02 13 A0 E3 01 00 80 E1 0E 14 A0 E3 10 20 A0 E3 02 26 A0 E1 00 30 D0 E5 00 40 D0 E5 04 00 53 E1 FB FF FF 1A 00 30 C1 E5 01 10 81 E2 01 00 80 E2 01 20 52 E2 F6 FF FF 1A 04 00 9F E5 10 FF 2F E1 00 7F 00 03 D0 00 00 08 FF B4 13 48 00 90 13 4C 63 1C 13 4F 3D 78 00 78 7A 1C 85 42 1A D0 38 70 10 78 46 1C 30 06 00 0E 10 70 3B 28 12 DD 00 26 16 70 1E 78 76 1E 31 06 09 0E FF 29 09 D1 3B 26 1E 70 26 78 76 1E 31 40 FF 29 00 D1 17 21 21 70 00 E0 19 70 06 E0 00 00 B5 4E 02 02 3E 4F 02 02 80 F0 03 02 FF BC 04 48 01 88 04 4A 10 1C 03 1C 4B 40 03 49 08 47 00 47 30 01 00 04 FF 03 00 00 6B 05 00 08 0F B4 0A 48 0A 49 FF 22 01 70 40 1C 88 42 FB D1 01 24 08 48 00 47 0F BC 30 BC 01 BC 00 47 00 24 04 49 08 47 F0 BC 02 BC 08 47 00 00 00 00 00 0E 00 00 01 0E 4C 01 F7 08 00 00 00 00 1F B4 0A 49 0A 4A 0B 4B 0C 68 1C 60 09 1D 1B 1D 91 42 F9 D1 08 49 08 47 08 4B 00 28 02 D0 01 21 19 70 01 E0 00 21 19 70 1F BC 70 47 24 01 F7 08 4C 01 F7 08 00 FC 03 02 01 FC 03 02 00 00 00 09 FF 00 2D E9 FC 00 9F E5 1C 10 1F E5 B0 20 D0 E1 B0 20 C1 E1 F0 00 9F E5 F0 10 9F E5 B0 20 D0 E1 B2 20 C1 E0 01 03 A0 E3 B2 28 D0 E1 B2 20 C1 E0 B0 28 D0 E1 B2 20 C1 E0 BA 2B D0 E1 B2 20 C1 E0 B6 2C D0 E1 B2 20 C1 E0 B2 2D D0 E1 B2 20 C1 E0 BE 2D D0 E1 B2 20 C1 E0 00 00 A0 E3 A4 10 9F E5 B0 00 C1 E1 A0 10 9F E5 B0 00 C1 E1 01 13 A0 E3 B0 08 C1 E1 BA 0B C1 E1 B6 0C C1 E1 B2 0D C1 E1 BE 0D C1 E1 03 00 A0 E3 B2 08 C1 E1 80 00 9F E5 B0 10 D0 E1 21 00 00 EA 68 00 9F E5 B0 10 1F E5 B0 20 D1 E1 B0 20 C0 E1 5C 00 9F E5 5C 10 9F E5 B2 20 D1 E0 B0 20 C0 E1 01 03 A0 E3 B2 20 D1 E0 B2 28 C0 E1 B2 20 D1 E0 B0 28 C0 E1 B2 20 D1 E0 BA 2B C0 E1 B2 20 D1 E0 B6 2C C0 E1 B2 20 D1 E0 B2 2D C0 E1 B2 20 D1 E0 BE 2D C0 E1 FF 00 BD E8 01 00 54 E3 01 00 00 0A 18 10 9F E5 11 FF 2F E1 14 00 9F E5 10 FF 2F E1 08 02 00 04 00 02 00 04 02 FC 03 02 84 00 00 04 F5 00 F7 08 E7 00 F7 08 88 01 9F E5 88 11 9F E5 88 21 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 64 01 9F E5 10 FF 2F E1 68 01 9F E5 68 11 9F E5 B0 00 C1 E1 64 01 9F E5 B0 00 C1 E1 60 01 9F E5 B0 10 D0 E1 5C 21 9F E5 02 00 51 E1 04 00 00 1A 40 01 9F E5 02 13 A0 E3 B0 00 C1 E1 00 00 A0 E3 36 00 00 EA 02 03 A0 E3 FF 10 A0 E3 B0 10 C0 E1 00 00 A0 E1 50 10 A0 E3 B0 10 C0 E1 00 00 A0 E1 90 10 A0 E3 B0 10 C0 E1 00 00 A0 E1 08 20 A0 E3 B0 10 D0 E1 8A 00 51 E3 08 00 00 0A 01 20 52 E2 FA FF FF 1A 89 00 51 E3 26 00 00 0A 02 03 A0 E3 F0 10 A0 E3 B0 10 C0 E1 02 00 A0 E3 1F 00 00 EA 02 03 A0 E3 FF 10 A0 E3 B0 10 C0 E1 00 00 A0 E1 90 10 A0 E3 B0 10 C0 E1 00 00 A0 E1 02 03 A0 E3 02 00 80 E2 B0 10 D0 E1 BC 20 9F E5 02 00 51 E1 03 00 00 1A FF 10 A0 E3 B0 10 C0 E1 03 00 A0 E3 0E 00 00 EA A4 20 9F E5 02 00 51 E1 05 00 00 1A 02 00 50 E2 00 60 A0 E3 FF 10 A0 E3 B0 10 C0 E1 01 00 A0 E3 05 00 00 EA 84 20 9F E5 02 00 51 E1 F6 FF FF 0A F0 10 A0 E3 B0 10 C0 E1 00 00 A0 E3 70 10 9F E5 11 FF 2F E1 FF 60 A0 E3 FF 10 A0 E3 B0 10 C0 E1 01 00 A0 E3 F8 FF FF EA 00 00 50 E3 05 00 00 0A 01 00 50 E3 04 00 00 0A 02 00 50 E3 03 00 00 0A 03 00 50 E3 02 00 00 0A 0F 00 00 EA D5 00 00 EA 77 00 00 EA 44 01 00 EA 10 FC 03 02 98 02 F7 08 2C 04 F7 08 F0 F0 00 00 54 01 00 08 98 98 00 00 40 00 00 08 52 51 00 00 15 88 00 00 7D 88 00 00 B0 88 00 00 CC 03 F7 08 00 00 A0 E1 3C 00 1F E5 60 11 9F E5 60 21 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 60 00 1F E5 10 FF 2F E1 F8 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 30 01 9F E5 30 11 9F E5 30 41 9F E5 30 51 9F E5 30 31 9F E5 01 30 53 E2 B0 30 C2 E1 B0 40 C0 E1 B0 50 C1 E1 20 31 9F E5 B0 30 C0 E1 B0 40 C0 E1 B0 50 C1 E1 14 31 9F E5 B0 30 C2 E1 0C 00 00 EB 0C 31 9F E5 02 30 53 E2 B0 30 C2 E1 B0 40 C0 E1 B0 50 C1 E1 FC 30 9F E5 B0 30 C0 E1 1D 00 00 EB F4 30 9F E5 03 30 53 E2 B0 30 C2 E1 EC 00 9F E5 10 FF 2F E1 00 40 2D E9 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 02 09 16 E3 04 00 00 1A 02 0A 16 E3 F8 FF FF 0A B0 60 D2 E1 02 09 16 E3 F5 FF FF 0A 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 80 00 16 E3 04 00 00 1A 20 00 16 E3 F8 FF FF 0A B0 60 D2 E1 80 00 16 E3 F5 FF FF 0A 00 40 BD E8 0E F0 A0 E1 04 40 2D E9 0E 14 A0 E3 10 30 A0 E3 03 36 A0 E1 01 60 D1 E4 01 70 D1 E4 07 64 86 E1 68 50 9F E5 B0 50 C2 E1 00 00 A0 E1 B0 60 C2 E1 01 0C A0 E3 B0 70 D2 E1 07 00 56 E1 01 00 00 0A 01 00 50 E2 FA FF FF 1A 02 20 82 E2 02 30 53 E2 EF FF FF 1A 04 40 BD E8 0E F0 A0 E1 5C 04 F7 08 D4 05 F7 08 54 15 00 08 AA 0A 00 08 A9 AA 00 00 56 55 00 00 F1 F0 00 00 80 80 00 00 30 30 00 00 F2 F0 00 00 20 20 00 00 F3 F0 00 00 E4 01 F7 08 A0 A0 00 00 00 00 A0 E1 E4 01 1F E5 50 11 9F E5 50 21 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 08 02 1F E5 10 FF 2F E1 F8 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 20 01 9F E5 03 00 50 E2 1C 11 9F E5 A9 40 A0 E3 56 50 A0 E3 16 00 00 EB B0 40 C0 E1 B0 50 C1 E1 80 30 A0 E3 B0 30 C0 E1 B0 40 C0 E1 B0 50 C1 E1 30 30 A0 E3 B0 30 C2 E1 2A 00 00 EB 0C 00 00 EB B0 40 C0 E1 B0 50 C1 E1 20 30 A0 E3 B0 30 C0 E1 0E 00 00 EB 90 30 A0 E3 B0 30 C2 E1 00 30 A0 E3 B0 30 C2 E1 02 00 00 EB C0 00 9F E5 03 00 50 E2 10 FF 2F E1 00 40 2D E9 B0 40 C0 E1 B0 50 C1 E1 F0 30 A0 E3 B0 30 C2 E1 00 40 BD E8 0E F0 A0 E1 3F 40 2D E9 0E 14 A0 E3 10 30 A0 E3 03 36 A0 E1 01 60 D1 E4 01 70 D1 E4 07 64 86 E1 A0 50 A0 E3 B0 50 C2 E1 00 00 A0 E1 B0 60 C2 E1 01 0C A0 E3 B0 70 D2 E1 07 00 56 E1 01 00 00 0A 01 00 50 E2 FA FF FF 1A 02 20 82 E2 02 30 53 E2 EF FF FF 1A 3F 40 BD E8 0E F0 A0 E1 04 40 2D E9 01 36 A0 E3 01 30 53 E2 07 00 00 0A B0 60 D2 E1 80 00 16 E3 04 00 00 1A 20 00 16 E3 F8 FF FF 0A B0 60 D2 E1 80 00 16 E3 F5 FF FF 0A 04 40 BD E8 0E F0 A0 E1 04 06 F7 08 48 07 F7 08 AD 0A 00 08 54 05 00 08 E7 01 F7 08 00 00 A0 E1 58 03 1F E5 A4 11 9F E5 A4 21 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 7C 03 1F E5 10 FF 2F E1 F8 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 36 00 00 EB 0E 54 A0 E3 10 30 A0 E3 03 36 A0 E1 02 00 00 EB 60 01 9F E5 01 00 50 E2 10 FF 2F E1 00 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 70 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 56 E3 01 00 00 0A E9 00 A0 E3 00 00 00 EA EA 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 04 01 9F E5 B0 00 C2 E1 00 00 A0 E1 02 1C A0 E3 00 00 D5 E5 01 50 85 E2 00 70 D5 E5 01 50 85 E2 07 04 80 E1 B0 00 C2 E1 02 20 82 E2 01 10 51 E2 F6 FF FF 1A D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 01 4B A0 E3 04 30 53 E0 D4 FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 40 BD E8 0E F0 A0 E1 04 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 60 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 90 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 02 20 82 E2 00 00 D2 E5 03 00 00 E2 FC FF FF 1A 02 20 52 E2 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 20 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 04 40 BD E8 0E F0 A0 E1 78 07 F7 08 0C 09 F7 08 E5 01 F7 08 FF 01 00 00 00 00 A0 E1 1C 05 1F E5 68 11 9F E5 68 21 9F E5 00 30 91 E5 00 30 80 E5 04 10 81 E2 04 00 80 E2 02 00 51 E1 F9 FF FF 1A 40 05 1F E5 10 FF 2F E1 F8 20 A0 E3 02 28 A0 E1 02 03 A0 E3 00 20 82 E1 27 00 00 EB 0E 54 A0 E3 10 30 A0 E3 03 36 A0 E1 02 00 00 EB 24 01 9F E5 06 00 50 E2 10 FF 2F E1 00 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 70 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 40 00 A0 E3 B0 00 C2 E1 00 60 D5 E5 01 50 85 E2 00 70 D5 E5 01 50 85 E2 07 64 86 E1 B0 60 C2 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 02 20 82 E2 02 30 53 E2 E3 FF FF 1A FF 00 A0 E3 B0 00 C2 E1 00 40 BD E8 0E F0 A0 E1 04 40 2D E9 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 60 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 90 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 02 20 82 E2 00 00 D2 E5 03 00 00 E2 FC FF FF 1A 02 20 52 E2 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 20 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 D0 00 A0 E3 B0 00 C2 E1 00 00 A0 E1 00 00 D2 E5 FF 00 00 E2 80 00 50 E3 FB FF FF 1A 00 00 A0 E1 FF 00 A0 E3 B0 00 C2 E1 04 40 BD E8 0E F0 A0 E1 3C 09 F7 08 90 0A F7 08 EA 01 F7 08 00 00 A0 E1 00 00 A0 E1");       
        private const int originalBlobPosition = 0x00F70000;
        private const int ENTRY1_OFF = 0x00D1; 
        private const int ENTRY2_OFF = 0x00EF;


        private static readonly byte[] CHECK_PRE_CTX = Hex("FF 21 09 01 01 40 00 29");
        private static readonly byte[] CHECK_ORIG    = Hex("17 D1");
        private static readonly byte[] CHECK_PATCH   = Hex("C0 46");

        private static readonly byte[] EP1_ORIG_TAIL = Hex("1F 2C F6 D9 30 BC 01 BC 00 47 00 00");
        private static readonly byte[] EP2_ORIG_TAIL = Hex("08 60 28 1C F0 BC 02 BC 08 47 00 00");

        private static Dictionary<uint, byte[]> toReplaceCalls = new Dictionary<uint, byte[]> {

        };
        private static Dictionary<uint, byte[]> toReplaceCallsFirst = new Dictionary<uint, byte[]> {

        };

        private static byte[] Hex(string s) =>
            Convert.FromHexString(new string(s.Where(c => !char.IsWhiteSpace(c)).ToArray()));

        public static byte[] ApplyBatterylessPatch(
            byte[] rom, bool repack)
        {
            if (rom is null || rom.Length < 0x200)
                throw new ArgumentException("ROM non valida o troppo corta.");
            
            Console.WriteLine("[INFO] Repacking to apply patches");
            byte[] outRom;
            if (repack)
            {
                outRom = Repack.repack(rom, new() { });
            }
            else
            {
                outRom = rom;
            }
            Console.WriteLine("[INFO] Applying patches");
            //SRAM PATCHES
            SRAMPatcher.ApplySRAMPatch(outRom);
            //BLOB
            int blobOff = Utils.FindFirstFreeForBlob(outRom, BLOB.Length, 0, 0x0500000);
            uint blobBase = Utils.ROM_BASE + (uint)blobOff;
            Console.WriteLine($"[INFO] BLOB rilocato a {blobOff:X}");
            Utils.CopyBlobAndFixInternals(outRom, BLOB, originalBlobPosition, blobOff, toReplaceCalls, toReplaceCallsFirst);
            Utils.PatchROMStartOffsetToBlob(outRom, blobBase);

            int ep1 = Utils.FindPatternForPatch(outRom, EP1_ORIG_TAIL, true);
            if (ep1 >= 0)
            {
                Utils.ApplyPatch1(outRom, ep1 + 4,  target: blobBase + ENTRY1_OFF);
            }
            else
            {
                Console.WriteLine("[PATCH] Patch 1 pattern not found");
            }
            int ep2 = Utils.FindPatternForPatch(outRom, EP2_ORIG_TAIL, true);
            if (ep2 >= 0)
            {
                Utils.ApplyPatch3(outRom, ep2 + 4, target: blobBase + ENTRY2_OFF);
            }
            else
            {
                Console.WriteLine("[PATCH] Patch 2 pattern not found");
            }
            int chk = Utils.FindCheckAndPatch(outRom, CHECK_PRE_CTX, CHECK_ORIG, CHECK_PATCH);
            Console.WriteLine("[INFO] ROM Patched");
            return outRom;
        }

        

        

        

        
    }
}
